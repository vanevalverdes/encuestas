{% extends "backend/custom/surround.html" %}

{% macro render_stats_panel(results, field_definitions) %}
<div class="container my-5">
    {# Intentamos obtener el total general de registros de cualquier campo para el N #}
    {% set total_records = results[results.keys()|first]['Total_General_T'] if results else 0 %}
    <h2 class="mb-5 text-center text-primary">📊 Análisis de Frecuencias y Distribución (N={{ total_records }})</h2>

    {% set h_key = 'H' %}
    {% set m_key = 'M' %}
    {% set t_key = 'T' %}
    {% set abs_data_key = 'data' %}
    {% set pct_data_key = 'pct_data' %}
    
    {% set group_h_label = 'Hombres' %}
    {% set group_m_label = 'Mujeres' %}
    {% set group_t_label = 'Total' %}
    
    {% set excluded_fields = ['id', 'createdby_id', 'created_at', 'contact'] %}

    {# Itera sobre cada campo principal #}
    {% for field_name, field_stats in results.items() %}
        
        {% if field_name not in excluded_fields %} 
            
            {# 1. Obtener el LABEL (Título de la pregunta) #}
            {% set field_definition = field_definitions.get(field_name) %}
            {% set panel_title = field_definition.label if field_definition and field_definition.label else field_name | replace('_', ' ') | capitalize %}

            <div class="card shadow-lg mb-4">
                <div class="card-header bg-dark text-white">
                    {# USAMOS LA VARIABLE PANEL_TITLE CON EL LABEL #}
                    <h4 class="mb-0">{{ panel_title }}
                        <span class="badge bg-secondary ms-3">
                            Total Respuestas: {{ field_stats['Total_General_T'] }}
                        </span>
                    </h4>
                </div>
                
                <div class="card-body p-3">
                    
                    <div class="row g-4">
                        
                        {# -------------------------- COLUMNA 1: VALORES ABSOLUTOS -------------------------- #}
                        <div class="col-12 col-md-6">
                            <div class="card border-primary h-100">
                                <div class="card-header bg-primary text-white small py-2">
                                    <i class="bi bi-bar-chart-fill me-1"></i>
                                    Valores Absolutos (Conteo)
                                </div>
                                <div class="card-body p-2">
                                    {{ render_table(field_stats[abs_data_key], h_key, m_key, t_key, group_h_label, group_m_label, group_t_label, is_percentage=false) }}
                                </div>
                                <div class="card-footer text-muted small py-1">
                                    Hombres: {{ field_stats['Total_General_H'] }} | Mujeres: {{ field_stats['Total_General_M'] }}
                                </div>
                            </div>
                        </div>

                        {# -------------------------- COLUMNA 2: PORCENTAJES -------------------------- #}
                        <div class="col-12 col-md-6">
                            <div class="card border-success h-100">
                                <div class="card-header bg-success text-white small py-2">
                                    <i class="bi bi-percent me-1"></i>
                                    Distribución Porcentual (%)
                                </div>
                                <div class="card-body p-2">
                                    {{ render_table(field_stats[pct_data_key], h_key, m_key, t_key, group_h_label, group_m_label, group_t_label, is_percentage=true) }}
                                </div>
                                <div class="card-footer text-muted small py-1">
                                    Base 100% en Total de respuestas por Género
                                </div>
                            </div>
                        </div>

                    </div>
                </div>
            </div>
            
        {% endif %}
        
    {% endfor %}
</div>
{% endmacro %}

{# ---------------------------------------------------------------------- #}
{# SUB-MACRO PARA RENDERIZAR LA TABLA (Sin cambios en su lógica) #}
{# ---------------------------------------------------------------------- #}
{% macro render_table(data, h_key, m_key, t_key, group_h_label, group_m_label, group_t_label, is_percentage) %}
    <div class="table-responsive">
        <table class="table table-sm table-striped table-hover mb-0">
            <thead class="table-light">
                <tr>
                    <th class="align-top" style="width: 45%;">Opción de Respuesta</th>
                    <th class="text-center align-top">{{ group_h_label }}</th>
                    <th class="text-center align-top">{{ group_m_label }}</th>
                    <th class="text-end align-top fw-bold">{{ group_t_label }}</th>
                </tr>
            </thead>
            <tbody>
                {% for option_value, counts in data.items() %}
                    <tr>
                        {# Opción de respuesta (truncada si es muy larga) #}
                        <td>{{ option_value | string | truncate(40, end='...') }}</td>
                        
                        {# Hombres #}
                        <td class="text-center">
                            {{ counts[h_key] }}
                            {% if is_percentage %} % {% endif %}
                        </td>
                        
                        {# Mujeres #}
                        <td class="text-center">
                            {{ counts[m_key] }}
                            {% if is_percentage %} % {% endif %}
                        </td>
                        
                        {# Total de Opción #}
                        <td class="text-end fw-bold">
                            {{ counts[t_key] }}
                            {% if is_percentage %} % {% endif %}
                        </td>
                    </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
{% endmacro %}

{% block content %}
{% if results and field_definitions %}
    {# AHORA LLAMAMOS AL MACRO CON AMBAS VARIABLES #}
    {{ render_stats_panel(results, field_definitions) }}
{% else %}
    <div class="alert alert-warning text-center m-5">
        No hay datos estadísticos para mostrar o faltan las definiciones de campos.
    </div>
{% endif %}
{%endblock%}