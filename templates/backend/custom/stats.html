{% extends "backend/custom/surround.html" %}

{# ---------------------------------------------------------------------- #}
{# MACRO PARA RENDERIZAR UNA TABLA DE FRECUENCIAS (ESTILO UNIFICADO Y LIGERO) #}
{# ---------------------------------------------------------------------- #}
{% macro render_stats_table(results, field_definitions, title_prefix="") %}
    
    {% set excluded_fields = ['id', 'createdby_id', 'created_at', 'contact'] %}

    <div class="container my-5">
        {% set first_var_key = results.keys()|first if results else None %}
        {% if first_var_key %}
            {% set totalT = results[first_var_key].Total_General_T %}
            <h2 class="mb-4 text-dark fw-bold">{{ title_prefix }}Análisis de Frecuencias (N={{ totalT | int }})</h2>
        {% endif %}
        
        <!-- Itera sobre cada campo principal -->
        {% for field_name, field_stats in results.items() %}
            
            {% if field_name not in excluded_fields %} 
                
                {# Obtener el LABEL (Título de la pregunta) #}
                {% set field_definition = field_definitions.get(field_name) %}
                {% set panel_title = field_definition.label if field_definition and field_definition.label else field_name | replace('_', ' ') | capitalize %}

                <div class="card shadow-sm mb-5 rounded-3 border-0">
                    <div class="card-header bg-primary-subtle border-0 py-3">
                        <h4 class="mb-0 fw-bold h5 text-primary">{{ panel_title }}
                            <span class="badge bg-dark-subtle text-dark ms-3">
                                Total Respuestas: {{ field_stats['Total_General_T'] | int }}
                            </span>
                        </h4>
                    </div>
                    
                    <div class="card-body p-3">
                        <div class="table-responsive">
                            {% set processedData = field_stats.data.items() | list | sort(attribute='1.T', reverse=True) %}

                            <table class="table table-striped table-hover caption-top align-middle mb-0">
                                <caption class="fw-semibold text-muted">Detalle de Frecuencias y Distribución por Género</caption>
                                <thead class="table-primary">
                                    <tr>
                                        <th scope="col" class="fw-bold">Opción de Respuesta</th>
                                        <th scope="col" class="text-end fw-bold">Hombres (H)</th>
                                        <th scope="col" class="text-end fw-bold">Mujeres (M)</th>
                                        <th scope="col" class="text-end fw-bold">Total (T)</th>
                                        <th scope="col" class="text-end fw-bold">% Total</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for group, values in processedData %}
                                        {# Usamos los datos porcentuales precalculados #}
                                        {% set pctT = field_stats.pct_data[group].T | float | round(1) %}
                                        {% set pctH = field_stats.pct_data[group].H | float | round(1) %}
                                        {% set pctM = field_stats.pct_data[group].M | float | round(1) %}
                                    <tr>
                                        <td>{{ group | string | truncate(40, end='...') }}</td>
                                        
                                        <td class="text-end">{{ values.H | int }} <span class="badge bg-primary-subtle text-primary">{{ pctH }}%</span></td>
                                        <td class="text-end">{{ values.M | int }} <span class="badge bg-danger-subtle text-danger">{{ pctM }}%</span></td>
                                        
                                        <td class="text-end fw-semibold">{{ values.T | int }}</td>
                                        <td class="text-end fw-bold text-success">{{ (values.T / field_stats.Total_General_T * 100) | float | round(1) }}%</td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                                <tfoot class="table-group-divider">
                                    <tr class="table-secondary">
                                        <th scope="row" class="text-end">Total General</th>
                                        <th class="text-end">{{ field_stats.Total_General_H | int }}</th>
                                        <th class="text-end">{{ field_stats.Total_General_M | int }}</th>
                                        <th class="text-end">{{ field_stats.Total_General_T | int }}</th>
                                        <th class="text-end">100.0%</th>
                                    </tr>
                                </tfoot>
                            </table>
                        </div>
                    </div>
                </div>
            {% endif %}
        {% endfor %}
    </div>
{% endmacro %}

{# ---------------------------------------------------------------------- #}
{# BLOQUE PRINCIPAL DE CONTENIDO #}
{# ---------------------------------------------------------------------- #}
{% block content %}
<div class="container my-5">
    
    {# -------------------------- REPORTE DE CARGA POR USUARIO -------------------------- #}
    {% if sorted_user_ids and data_by_user and grand_total %}
    <div class="card shadow-lg mb-5 rounded-3 border-secondary border-3">
        <div class="card-header bg-secondary text-white rounded-top-3 py-3">
            <h2 class="mb-0 fw-bold h4">Reporte de Carga por Usuario (HOY)</h2>
        </div>
        <div class="card-body p-3">
            <div class="table-responsive">
                <table class="table table-bordered table-striped table-hover mb-0 align-middle">
                    <thead class="table-dark">
                        <tr>
                            <th class="align-middle">Género / Usuario</th>
                            
                            {% for user_id in sorted_user_ids %}
                                <th class="text-center align-middle">Usuario {{ user_id }}</th>
                            {% endfor %}
                            
                            <th class="text-center bg-danger text-white align-middle">TOTAL</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <th>Hombres ({{ CLAVE_HOMBRES }})</th>
                            {% for user_id in sorted_user_ids %}
                                <td class="text-center">{{ data_by_user[user_id]['hombres'] | int }}</td>
                            {% endfor %}
                            <td class="text-center fw-bold bg-danger text-white">{{ grand_total['hombres'] | int }}</td>
                        </tr>

                        <tr>
                            <th>Mujeres ({{ CLAVE_MUJERES }})</th>
                            {% for user_id in sorted_user_ids %}
                                <td class="text-center">{{ data_by_user[user_id]['mujeres'] | int }}</td>
                            {% endfor %}
                            <td class="text-center fw-bold bg-danger text-white">{{ grand_total['mujeres'] | int }}</td>
                        </tr>

                        <tr class="table-secondary">
                            <th class="bg-secondary text-white">TOTAL</th>
                            {% for user_id in sorted_user_ids %}
                                <td class="text-center fw-bold">{{ data_by_user[user_id]['total'] | int }}</td>
                            {% endfor %}
                            <td class="text-center fw-bold bg-danger text-white">{{ grand_total['total'] | int }}</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>
    {% endif %}
    {# -------------------------- FIN REPORTE POR USUARIO -------------------------- #}

    {% if results and field_definitions %}
        {# PRIMER LLAMADO: RESULTS #}
        {{ render_stats_table(results, field_definitions, title_prefix="Análisis de Variables Demográficas y Preferencias - ") }}
        
        {# SEGUNDO LLAMADO: WILLVOTERESULTS (si existe) #}
        {% if willvoteresults %}
            <div class="mt-5 pt-3 border-top">
                {{ render_stats_table(willvoteresults, field_definitions, title_prefix="Resultados Adicionales de Votación - ") }}
            </div>
        {% endif %}

    {% elif not sorted_user_ids or not data_by_user %}
        <div class="alert alert-warning text-center">
            No hay datos de carga de usuarios disponibles o faltan las variables de contexto.
        </div>
    {% else %}
        <div class="alert alert-warning text-center m-5">
            No hay datos estadísticos para mostrar o faltan las definiciones de campos ('results' y 'field_definitions').
        </div>
    {% endif %}
</div>
{%endblock%}
