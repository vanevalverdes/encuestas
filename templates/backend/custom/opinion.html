{% import "backend/macros.html" as macros %}
{% extends "backend/custom/surround.html" %}

{% block content %}
<script>
function toggleDivOnSelectValue(selectId, divId, value) {
    document.addEventListener("DOMContentLoaded", function () {
        // 1. Obtener el elemento SELECT por ID
        const selectElement = document.getElementById(selectId);
        
        // 2. Obtener el DIV objetivo por ID
        const targetDiv = document.getElementById(divId);
        
        // Si el elemento SELECT o el DIV no existen, salir
        if (!selectElement || !targetDiv) return;

        // 3. Obtener todos los campos de entrada dentro del DIV objetivo
        const inputs = targetDiv.querySelectorAll("input, textarea, select");

        function toggleDiv() {
            // Obtener el valor de la opción seleccionada
            const selectedValue = selectElement.value;
            
            if (selectedValue === value) {
                // MOSTRAR el div y HABILITAR los campos
                targetDiv.style.display = "block";
                inputs.forEach(input => input.removeAttribute("disabled"));
            } else {
                // OCULTAR el div y DESHABILITAR/LIMPIAR los campos
                targetDiv.style.display = "none";
                inputs.forEach(input => {
                    // Deshabilita el campo para que no se envíe con el formulario
                    input.setAttribute("disabled", "true");
                    
                    // Opcional: Limpia los valores para evitar envíos accidentales
                    if (input.type === 'checkbox' || input.type === 'radio') {
                        input.checked = false;
                    } else if (input.tagName === 'SELECT') {
                        // Resetea el select a la primera opción si es posible
                        input.selectedIndex = 0; 
                    } else {
                        input.value = '';
                    }
                });
            }
        }

        // 4. Agregar el listener 'change' al elemento SELECT
        selectElement.addEventListener("change", toggleDiv);

        // 5. Ejecutar la función inmediatamente al cargar la página para establecer el estado inicial
        toggleDiv();
    });
}
function toggleDivOnRadioValue(name, divId, value) {
    document.addEventListener("DOMContentLoaded", function () {
        const radios = document.querySelectorAll(`input[name="${name}"]`);
        const targetDiv = document.getElementById(divId);
        if (!targetDiv) return;
        const inputs = targetDiv.querySelectorAll("input");

        function toggleDiv() {
            const selectedValue = document.querySelector(`input[name="${name}"]:checked`)?.value;
            if (selectedValue === value) {
                targetDiv.style.display = "block";
                inputs.forEach(input => input.removeAttribute("disabled"));
            } else {
                targetDiv.style.display = "none";
                inputs.forEach(input => {
                    input.setAttribute("disabled", "true");
                    input.checked = false;
                });
            }
        }

        radios.forEach(radio => {
            radio.addEventListener("change", toggleDiv);
        });

        toggleDiv();
    });
}

function toggleDivOnRadioNotValue(name, divId, value) {
    document.addEventListener("DOMContentLoaded", function () {
        const radios = document.querySelectorAll(`input[name="${name}"]`);
        const targetDiv = document.getElementById(divId);
        if (!targetDiv) return;
        const inputs = targetDiv.querySelectorAll("input");

        function toggleDiv() {
            const selectedValue = document.querySelector(`input[name="${name}"]:checked`)?.value;
            if (selectedValue !== value && selectedValue !== undefined) {
                targetDiv.style.display = "block";
                inputs.forEach(input => input.removeAttribute("disabled"));
            } else {
                targetDiv.style.display = "none";
                inputs.forEach(input => {
                    input.setAttribute("disabled", "true");
                    input.checked = false;
                });
            }
        }

        radios.forEach(radio => {
            radio.addEventListener("change", toggleDiv);
        });

        toggleDiv();
    });
}

</script>
            <form method="post" enctype="multipart/form-data" id="form-record">
            <!-- Inputs ocultos -->
            <input type="hidden" id="csrf_token" name="csrf_token" value="{{ csrf_token() }}">
            <h1>Encuesta de Opinión Política Opol - Noviembre 2025</h1>
            <div class="bg-white shadow-sm rounded-3 p-4">
                <div class="card mb-4">
                    <div class="card-header bg-light fw-semibold">
                        Datos de la encuesta
                    </div>
                    <div class="card-body">
                        <div class="row g-4">
                            <div class="col-md-12">
                                {{ macros.fieldFormSurvey(fields["gender"],record,editable)}}
                                {{ macros.fieldFormSurvey(fields["age"],record,editable)}}
                            </div>
                        </div>
                        <div class="row g-4">
                            <div class="col-md-12">
                            <!-- Cantón y Provincia -->
                                <div class="mb-3 border border-grey p-3" id="countyDiv">
                                    <label for="county" class="form-label">Cantón</label>
                                    <select class="form-select" id="county" aria-label="Cantones de Costa Rica por provincia" name="county" required>
                                    <option value="" selected disabled>Seleccione un cantón</option>
                                    <optgroup label="San José">
                                        <option value="san-jose">San José</option>
                                        <option value="escazu">Escazú</option>
                                        <option value="desamparados">Desamparados</option>
                                        <option value="puriscal">Puriscal</option>
                                        <option value="tarrazu">Tarrazú</option>
                                        <option value="aserri">Aserrí</option>
                                        <option value="mora">Mora</option>
                                        <option value="goicoechea">Goicoechea</option>
                                        <option value="santa-ana">Santa Ana</option>
                                        <option value="alajuelita">Alajuelita</option>
                                        <option value="vazquez-de-coronado">Vázquez de Coronado</option>
                                        <option value="acosta">Acosta</option>
                                        <option value="tibas">Tibás</option>
                                        <option value="moravia">Moravia</option>
                                        <option value="montes-de-oca">Montes de Oca</option>
                                        <option value="turrubares">Turrubares</option>
                                        <option value="dota">Dota</option>
                                        <option value="curridabat">Curridabat</option>
                                        <option value="perez-zeledon">Pérez Zeledón</option>
                                        <option value="leon-cortes-castro">León Cortés Castro</option>
                                    </optgroup>
                                    <optgroup label="Alajuela">
                                        <option value="alajuela">Alajuela</option>
                                        <option value="san-ramon">San Ramón</option>
                                        <option value="grecia">Grecia</option>
                                        <option value="san-mateo">San Mateo</option>
                                        <option value="atenas">Atenas</option>
                                        <option value="naranjo">Naranjo</option>
                                        <option value="palmares">Palmares</option>
                                        <option value="poas">Poás</option>
                                        <option value="orotina">Orotina</option>
                                        <option value="san-carlos">San Carlos</option>
                                        <option value="zarcero">Zarcero</option>
                                        <option value="valverde-vega">Valverde Vega</option>
                                        <option value="upala">Upala</option>
                                        <option value="los-chiles">Los Chiles</option>
                                        <option value="guatuso">Guatuso</option>
                                        <option value="rio-cuarto">Río Cuarto</option>
                                    </optgroup>
                                    <optgroup label="Cartago">
                                        <option value="cartago">Cartago</option>
                                        <option value="paraiso">Paraíso</option>
                                        <option value="la-union">La Unión</option>
                                        <option value="jimenez">Jiménez</option>
                                        <option value="turrialba">Turrialba</option>
                                        <option value="alvarado">Alvarado</option>
                                        <option value="oremuno">Oreamuno</option>
                                        <option value="el-guarco">El Guarco</option>
                                    </optgroup>
                                    <optgroup label="Heredia">
                                        <option value="heredia">Heredia</option>
                                        <option value="barva">Barva</option>
                                        <option value="santo-domingo">Santo Domingo</option>
                                        <option value="santa-barbara">Santa Bárbara</option>
                                        <option value="san-rafael">San Rafael</option>
                                        <option value="san-isidro">San Isidro</option>
                                        <option value="belen">Belén</option>
                                        <option value="flores">Flores</option>
                                        <option value="san-pablo">San Pablo</option>
                                        <option value="sarapiqui">Sarapiquí</option>
                                    </optgroup>
                                    <optgroup label="Guanacaste">
                                        <option value="liberia">Liberia</option>
                                        <option value="nicoya">Nicoya</option>
                                        <option value="santa-cruz">Santa Cruz</option>
                                        <option value="bagaces">Bagaces</option>
                                        <option value="carrillo">Carrillo</option>
                                        <option value="cañas">Cañas</option>
                                        <option value="abangares">Abangares</option>
                                        <option value="tilaran">Tilarán</option>
                                        <option value="nandayure">Nandayure</option>
                                        <option value="la-cruz">La Cruz</option>
                                        <option value="hojancha">Hojancha</option>
                                    </optgroup>
                                    <optgroup label="Puntarenas">
                                        <option value="puntarenas">Puntarenas</option>
                                        <option value="esparza">Esparza</option>
                                        <option value="buenos-aires">Buenos Aires</option>
                                        <option value="montes-de-oro">Montes de Oro</option>
                                        <option value="osa">Osa</option>
                                        <option value="quepos">Quepos</option>
                                        <option value="golfito">Golfito</option>
                                        <option value="coto-brus">Coto Brus</option>
                                        <option value="parrita">Parrita</option>
                                        <option value="corredores">Corredores</option>
                                        <option value="garabito">Garabito</option>
                                        <option value="monteverde">Monteverde</option>
                                        <option value="puerto-jimenez">Puerto Jiménez</option>
                                    </optgroup>
                                    <optgroup label="Limón">
                                        <option value="limon">Limón</option>
                                        <option value="pococí">Pococí</option>
                                        <option value="siquirres">Siquirres</option>
                                        <option value="talamanca">Talamanca</option>
                                        <option value="matina">Matina</option>
                                        <option value="guacimo">Guácimo</option>
                                    </optgroup>
                                    </select>
                                </div>
                                <script>
                                    document.addEventListener('DOMContentLoaded', (event) => {
                                    const countySelect = document.getElementById('county');

                                    if (countySelect) {
                                        countySelect.addEventListener('change', (e) => {
                                        const selectedOption = e.target.options[e.target.selectedIndex];
                                        const provinceGroup = selectedOption.closest('optgroup');
                                        const containerDiv = document.getElementById('countyDiv');

                                        // Remover cualquier input 'state' hidden existente para evitar duplicados.
                                        const existingStateInput = containerDiv.querySelector('input[name="state"]');
                                        if (existingStateInput) {
                                            existingStateInput.remove();
                                        }

                                        if (provinceGroup) {
                                            // Obtener el nombre de la provincia del label de optgroup
                                            let provinceName = provinceGroup.label;
                                            
                                            // Formatear el nombre de la provincia a un valor de URL-friendly (lowercase, sin acentos, con guiones)
                                            let provinceValue = provinceName.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "").replace(/\s/g, '-');

                                            // Crear el input hidden
                                            const hiddenInput = document.createElement('input');
                                            hiddenInput.type = 'hidden';
                                            hiddenInput.name = 'state';
                                            hiddenInput.value = provinceValue;
                                            
                                            // Agregar el input hidden al div contenedor
                                            containerDiv.appendChild(hiddenInput);
                                        }
                                        });
                                    }
                                    });
                                </script>
                            </div>
                        </div>
                        <div class="row g-4">
                            <div class="col-md-12">
                                {{ macros.fieldFormSurvey(fields["education"],record,editable)}}
                                {{ macros.fieldFormSurvey(fields["religion"],record,editable)}}
                                {{ macros.fieldFormSurvey(fields["chavesSupport"],record,editable)}}
                                {{ macros.fieldFormSurvey(fields["chavesScale"],record,editable)}}
                            </div>
                            <script>
                                toggleDivOnSelectValue("chavesSupport", "lastMonth-div", "No");
                            </script>
                            <script>
                                toggleDivOnSelectValue("chavesSupport", "approveReason-div", "Sí");
                            </script>
                        </div>
                    </div>
                </div>
                <div class="card mb-4" style="display: none;" id="lastMonth-div">
                    <div class="card-body">
                        <div class="row g-4">
                            <div class="col-md-12">
                                {{ macros.fieldFormSurvey(fields["lastMonth"],record,editable)}}
                                <script>
                                    toggleDivOnSelectValue("lastMonth", "lastMonthOpinion-div", "Sí");
                                </script>
                                <div class="mb-4" style="display: none;" id="lastMonthOpinion-div">
                                {{ macros.fieldFormSurvey(fields["lastMonthOpinion"],record,editable)}}
                                </div>
                                {{ macros.fieldFormSurvey(fields["rejectReason"],record,editable)}}
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="card mb-4" style="display: none;" id="approveReason-div">
                    <div class="card-body">
                        <div class="row g-4">
                            <div class="col-md-12">
                                {{ macros.fieldFormSurvey(fields["approveReason"],record,editable)}}
                            </div>
                        </div>
                    </div>
                </div>
                <!--- Conoce y opina sobre políticos --->
                <div class="card mb-4">
                    <div class="card-body">
                        <div class="row g-4">
                            <div class="col-md-12">
                                {{ macros.fieldFormSurvey(fields["conoceChaves"],record,editable)}}
                                <script>
                                    toggleDivOnSelectValue("conoceChaves", "opinionChaves-div", "Sí");
                                </script>
                                <div class="mb-4" style="display: none;" id="opinionChaves-div">
                                {{ macros.fieldFormSurvey(fields["opinionChaves"],record,editable)}}
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="card mb-4">
                    <div class="card-body">
                        <div class="row g-4">
                            <div class="col-md-12">
                                {{ macros.fieldFormSurvey(fields["conoceLaura"],record,editable)}}
                                <script>
                                    toggleDivOnSelectValue("conoceLaura", "opinionLaura-div", "Sí");
                                </script>
                                <div class="mb-4" style="display: none;" id="opinionLaura-div">
                                {{ macros.fieldFormSurvey(fields["opinionLaura"],record,editable)}}
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="card mb-4">
                    <div class="card-body">
                        <div class="row g-4">
                            <div class="col-md-12">
                                {{ macros.fieldFormSurvey(fields["conocePilar"],record,editable)}}
                                <script>
                                    toggleDivOnSelectValue("conocePilar", "opinionPilar-div", "Sí");
                                </script>
                                <div class="mb-4" style="display: none;" id="opinionPilar-div">
                                {{ macros.fieldFormSurvey(fields["opinionPilar"],record,editable)}}
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="card mb-4">
                    <div class="card-body">
                        <div class="row g-4">
                            <div class="col-md-12">
                                {{ macros.fieldFormSurvey(fields["conoceRamos"],record,editable)}}
                                <script>
                                    toggleDivOnSelectValue("conoceRamos", "opinionRamos-div", "Sí");
                                </script>
                                <div class="mb-4" style="display: none;" id="opinionRamos-div">
                                {{ macros.fieldFormSurvey(fields["opinionRamos"],record,editable)}}
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="card mb-4">
                    <div class="card-body">
                        <div class="row g-4">
                            <div class="col-md-12">
                                {{ macros.fieldFormSurvey(fields["conoceFabricio"],record,editable)}}
                                <script>
                                    toggleDivOnSelectValue("conoceFabricio", "opinionFabricio-div", "Sí");
                                </script>
                                <div class="mb-4" style="display: none;" id="opinionFabricio-div">
                                {{ macros.fieldFormSurvey(fields["opinionFabricio"],record,editable)}}
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="card mb-4">
                    <div class="card-body">
                        <div class="row g-4">
                            <div class="col-md-12">
                                {{ macros.fieldFormSurvey(fields["conoceAriel"],record,editable)}}
                                <script>
                                    toggleDivOnSelectValue("conoceAriel", "opinionAriel-div", "Sí");
                                </script>
                                <div class="mb-4" style="display: none;" id="opinionAriel-div">
                                {{ macros.fieldFormSurvey(fields["opinionAriel"],record,editable)}}
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="card mb-4">
                    <div class="card-body">
                        <div class="row g-4">
                            <div class="col-md-12">
                                {{ macros.fieldFormSurvey(fields["conoceClaudia"],record,editable)}}
                                <script>
                                    toggleDivOnSelectValue("conoceClaudia", "opinionClaudia-div", "Sí");
                                </script>
                                <div class="mb-4" style="display: none;" id="opinionClaudia-div">
                                {{ macros.fieldFormSurvey(fields["opinionClaudia"],record,editable)}}
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="card mb-4">
                    <div class="card-body">
                        <div class="row g-4">
                            <div class="col-md-12">
                                {{ macros.fieldFormSurvey(fields["conoceJuanCarlos"],record,editable)}}
                                <script>
                                    toggleDivOnSelectValue("conoceJuanCarlos", "opinionJuanCarlos-div", "Sí");
                                </script>
                                <div class="mb-4" style="display: none;" id="opinionJuanCarlos-div">
                                {{ macros.fieldFormSurvey(fields["opinionJuanCarlos"],record,editable)}}
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!--- FIN de Conoce y opina sobre políticos --->



                <div class="card mb-4">
                    <div class="card-body">
                        <div class="row g-4">
                            <div class="col-md-12">
                                <h4>Del 1 al 10, califique las siguientes instituciones:</h4>
                                {{ macros.fieldFormSurvey(fields["tse"],record,editable)}}
                                {{ macros.fieldFormSurvey(fields["poderJudicial"],record,editable)}}
                                {{ macros.fieldFormSurvey(fields["fiscaliaGeneral"],record,editable)}}
                                {{ macros.fieldFormSurvey(fields["ucr"],record,editable)}}
                                {{ macros.fieldFormSurvey(fields["universidades"],record,editable)}}
                                {{ macros.fieldFormSurvey(fields["asamblea"],record,editable)}}
                                {{ macros.fieldFormSurvey(fields["gobierno"],record,editable)}}
                                {{ macros.fieldFormSurvey(fields["contraloria"],record,editable)}}
                                {{ macros.fieldFormSurvey(fields["iglesia"],record,editable)}}
                                {{ macros.fieldFormSurvey(fields["sindicatos"],record,editable)}}
                                {{ macros.fieldFormSurvey(fields["partidos"],record,editable)}}
                                {{ macros.fieldFormSurvey(fields["ministros"],record,editable)}}
                                {{ macros.fieldFormSurvey(fields["medios"],record,editable)}}
                            </div>
                        </div>
                    </div>
                </div>
                <div class="card mb-4">
                    <div class="card-body">
                        <div class="row g-4">
                            <div class="col-md-12">
                                <h4>Sobre los siguientes temas, indique si usted está a favor o en contra:</h4>
                                {{ macros.fieldFormSurvey(fields["topicAsamblea"],record,editable)}}
                                {{ macros.fieldFormSurvey(fields["topicSubasta"],record,editable)}}
                                {{ macros.fieldFormSurvey(fields["topicTSE"],record,editable)}}
                                {{ macros.fieldFormSurvey(fields["topicFiscalia"],record,editable)}}
                            </div>
                        </div>
                    </div>
                </div>
                <div class="card mb-4">
                    <div class="card-body">
                        <div class="row g-4">
                            <div class="col-md-12">
                                {{ macros.fieldFormSurvey(fields["nationalElection"],record,editable)}}
                            </div>
                        </div>
                    </div>
                </div>
                <div class="card-body">
                    <div class="row g-4">
                        <div class="col-md-12">
                            {{ macros.fieldFormSurvey(fields["conoceROP"],record,editable)}}
                            <script>
                                toggleDivOnSelectValue("conoceROP", "opinionROP-div", "Sí");
                            </script>
                            <div class="mb-4" style="display: none;" id="opinionROP-div">
                            {{ macros.fieldFormSurvey(fields["opinionROP"],record,editable)}}
                            </div>
                        </div>
                    </div>
                </div>
                <div class="card mb-4">
                    <div class="card-body">
                        <div class="row g-4">
                            <div class="col-md-12">
                                {{ macros.fieldFormSurvey(fields["contact"],record,editable)}}
                            </div>
                        </div>
                    </div>
                </div>
                <button type="submit" class="btn btn-sm btn-secondary" form="form-record"><span class="material-icons align-middle">save</span>Guardar</button>
            </form>
{% endblock %}